<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>마이페이지</title>
    <link rel="stylesheet" href="/css/profile.css">
    <script src="/js/header.js"></script>
</head>
<body>

<!-- ✅ 헤더 -->
<div th:replace="~{fragments/header :: header}"></div>

<div class="profile-container">
    <div class="title-container">
        <h2>마이페이지</h2>
        <button id="manageAccountBtn" class="account-btn">계좌 관리</button>
        <button id="editProfileBtn" class="edit-btn">수정하기</button>
    </div>

    <p><strong>사용자 ID:</strong> <span id="userName" th:text="${name}"></span></p>
    <p><strong>이메일:</strong> <span id="userEmail" th:text="${email}"></span></p>
    <p><strong>역할:</strong> <span id="userRole" th:text="${role}"></span></p>
    <p><strong>가입일:</strong> <span id="userCreatedAt" th:text="${createdAt}"></span></p>
    <p><strong>최근 수정일:</strong> <span id="userUpdatedAt" th:text="${updatedAt}"></span></p>
</div>
<!-- 수정하기 버튼 -->
<!-- ✅ 사용자 정보 가져오기 -->
<script>
    document.addEventListener("DOMContentLoaded", async function () {
      const token = localStorage.getItem("accessToken");
      const username = window.location.pathname.split("/").pop(); // URL에서 username 추출

      if (!token) {
          console.warn("❌ JWT 토큰 없음! 로그인 페이지로 이동합니다.");
          alert("로그인이 필요합니다. 로그인 페이지로 이동합니다.");
          window.location.href = "/api/users/login";
          return;
      }

      console.log("🔹 저장된 JWT 토큰:", token);

      try {
          console.log(`📌 서버에 요청 중: GET /api/users/profile/${username}`);
          const response = await fetch(`/api/users/profile/${username}`, {
              method: "GET",
              headers: {
                  "Authorization": `Bearer ${token}`, // ✅ JWT 토큰 포함
                  "Content-Type": "application/json"
              }
          });

          console.log("📌 요청 헤더 확인:", {
              "Authorization": `Bearer ${token}`,
              "Content-Type": "application/json"
          });

          if (!response.ok) {
              console.error(`❌ 서버 응답 오류: ${response.status} - ${response.statusText}`);
              const errorText = await response.text();
              console.error("📌 서버 응답 본문 (원본 오류 메시지):", errorText);
              throw new Error(`서버 오류: ${response.status}`);
          }

          const data = await response.json();
          console.log("📌 서버 응답 데이터 (원본):", data);

          if (!data.data) {
              throw new Error("사용자 데이터가 존재하지 않습니다.");
          }

          // ✅ 프로필 데이터 반영
          document.getElementById("userName").textContent = data.data.name || "N/A";
          document.getElementById("userEmail").textContent = data.data.email || "N/A";
          document.getElementById("userRole").textContent = data.data.role || "N/A";
          document.getElementById("userCreatedAt").textContent = new Date(data.data.createdAt).toISOString().split("T")[0];
          document.getElementById("userUpdatedAt").textContent = new Date(data.data.updatedAt).toISOString().split("T")[0];

          console.log("✅ 프로필 데이터 반영 완료.");
      } catch (error) {
          console.error("❌ 프로필 불러오기 오류:", error);
          alert("프로필 정보를 불러오는 데 실패했습니다. 오류: " + error.message);
      }
  });
</script>

<!-- ✅ 버튼 이벤트 리스너 -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const username = window.location.pathname.split("/").pop(); // URL에서 username 추출

        // ✅ 수정 버튼
        const editProfileBtn = document.getElementById("editProfileBtn");
        if (editProfileBtn) {
            editProfileBtn.addEventListener("click", function () {
                const popup = window.open(`/profile/modify/${username}`, "EditProfilePopup", "width=500,height=400,scrollbars=no");
                if (!popup) {
                    alert("팝업이 차단되었습니다. 팝업 차단을 해제해주세요.");
                }
            });
        } else {
            console.error("❌ 수정 버튼을 찾을 수 없습니다.");
        }

        // ✅ 계좌 관리 버튼
        const manageAccountBtn = document.getElementById("manageAccountBtn");
        if (manageAccountBtn) {
            manageAccountBtn.addEventListener("click", function () {
                window.location.href = `/profile/account/${username}`;
            });
        } else {
            console.error("❌ 계좌 관리 버튼을 찾을 수 없습니다.");
        }
    });
</script>

</body>
</html>
