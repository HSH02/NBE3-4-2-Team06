<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>마이 페이지</title>
    <link rel="stylesheet" th:href="@{/css/profile.css}">
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>

<main id="mainContent"></main>

<script>
    document.addEventListener("DOMContentLoaded", async function () {
        const token = localStorage.getItem("accessToken");
        const username = window.location.pathname.split("/").pop();

        if (!token) {
            alert("로그인이 필요합니다. 로그인 페이지로 이동합니다.");
            window.location.href = "/api/users/login";
            return;
        }

        try {
            const response = await fetch(`/api/users/profile/${username}`, {
                method: "GET",
                headers: {
                    "Authorization": `Bearer ${token}`,
                    "Content-Type": "application/json"
                }
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`서버 오류: ${response.status}, ${errorText}`);
            }

            const data = await response.json();

            if (!data.data) {
                throw new Error("사용자 데이터가 존재하지 않습니다.");
            }

            const userInfo = data.data;

            const mainContent = document.getElementById("mainContent");
            mainContent.innerHTML = `
                <section class="profile-section">
                    <div class="profile-pic">
                       <!-- <img src="#" alt="#">-->
                        <button class="btn inquiry">문의하기</button>
                    </div>
                    <div class="profile-info">
                        <h2>내 정보</h2>
                        <p>이름: ${userInfo.name}</p>
                        <p>Email: ${userInfo.email}</p>
                        <p>역할: ${userInfo.role}</p>
                        <p>가상 계좌:  (${userInfo.name})</p>
                        <button class="btn info-change">내 정보 변경하기</button>
                        <button class="btn create-account">계좌관리</button>
                    </div>
                </section>

                <section class="project-status">
                    <h2>내 프로젝트 현황</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>프로젝트 타이틀</th>
                                <th>목표액</th>
                                <th>프로젝트 생성일</th>
                                <th>상태</th>
                                <th>승인여부</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>피아노 리사이틀</td>
                                <td>800,000원</td>
                                <td>2025.02.05</td>
                                <td>실패</td>
                                <td>거절</td>
                            </tr>
                            <tr>
                                <td>졸업 연주 공연</td>
                                <td>600,000원</td>
                                <td>2025.02.06</td>
                                <td>실패</td>
                                <td>승인</td>
                            </tr>
                            <tr>
                                <td>지역아동센터 봉사활동1</td>
                                <td>400,000원</td>
                                <td>2025.02.07</td>
                                <td>성공</td>
                                <td>승인</td>
                            </tr>
                            <tr>
                                <td>지역아동센터 봉사활동2</td>
                                <td>400,000원</td>
                                <td>2025.02.08</td>
                                <td>진행중</td>
                                <td>승인대기</td>
                                <td>
                                    <button class="btn edit">수정</button>
                                    <button class="btn cancel">취소</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </section>

                <section class="successful-projects">
                    <h2>성공한 프로젝트 목록</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>프로젝트 타이틀</th>
                                <th>목표액</th>
                                <th>모인 금액</th>
                                <th>프로젝트 마감일</th>
                                <th>입금 일자</th>
                                <th>입금 여부</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>지역아동센터 봉사활동2</td>
                                <td>400,000원</td>
                                <td>560,000원</td>
                                <td>2025.02.08</td>
                                <td>2025.02.09</td>
                                <td>입금 완료</td>
                            </tr>
                        </tbody>
                    </table>
                </section>

                <section class="inquiries">
                    <h2>내 문의 목록</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>문의 제목</th>
                                <th>작성 일자</th>
                                <th>수정 일자</th>
                                <th>답변 상태</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>문의있습니다. 1</td>
                                <td>2025.02.08</td>
                                <td>2025.02.09</td>
                                <td>답변 완료</td>
                            </tr>
                            <tr>
                                <td>문의있습니다. 2</td>
                                <td>2025.02.08</td>
                                <td>2025.02.08</td>
                                <td>대기중</td>
                                <td>
                                    <button class="btn edit">수정</button>
                                    <button class="btn cancel">취소</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </section>
            `;
        } catch (error) {
            alert("프로필 정보를 불러오는 데 실패했습니다. 오류: " + error.message);
        }
    });
</script>
</body>
</html>
